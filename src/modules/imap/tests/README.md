# IMAP Test Scripts

**Verzeichnis:** `src/modules/imap/tests/`  
**Status:** âœ… Production-Ready  
**Last Updated:** 17. November 2025

---

## ğŸ“ Directory Structure

```
tests/
â”œâ”€â”€ setup-autodiscover.php          # â­ Production setup wizard
â”œâ”€â”€ mercury-quick-test.php          # Development testing
â”œâ”€â”€ smtp-imap-roundtrip-test.php    # Generic provider testing
â”œâ”€â”€ README.md                       # This file
â”œâ”€â”€ mercury-config.json             # Generated by mercury-quick-test
â”œâ”€â”€ setup-config.json               # Generated by setup-autodiscover
â””â”€â”€ _archive/                       # Deprecated scripts
    â”œâ”€â”€ smtp-imap-autosetup.php     # Old auto-setup (deprecated)
    â”œâ”€â”€ manual-test.php             # Old manual test (deprecated)
    â””â”€â”€ README.md                   # Archive documentation
```

---

## Available Test Scripts

### 1. setup-autodiscover.php â­â­â­ **PRODUCTION-READY**

**Zweck:** Intelligenter Setup-Wizard mit vollautomatischer SMTP/IMAP-Erkennung

**Features:**
- âœ… Auto-Detection von IMAP/SMTP-Servern aus Email-Domain
- âœ… Intelligentes SMTP-Testing (8 verschiedene Konfigurationen)
- âœ… Automatisches Folder-Scanning (findet Test-Mail auch in gefilterten Ordnern)
- âœ… Konfiguration speichern (.env + JSON)
- âœ… User-freundlich (minimal Input, maximale Automation)
- âœ… Error-Recovery (manuelle Eingabe bei Fehlern)

**Verwendung:**
```bash
C:\xampp\php\php.exe src/modules/imap/tests/setup-autodiscover.php
```

**Ablauf:**
1. Email-Adresse eingeben â†’ Auto-detect IMAP/SMTP-Server
2. IMAP-Credentials â†’ Test Connection
3. SMTP auto-discover â†’ Test mit 8 Konfigurationen
4. Folder-Scanning â†’ Findet Test-Mail in allen Ordnern
5. Config speichern â†’ .env + setup-config.json

**Output:**
- `.env` (updated)
- `setup-config.json` (vollstÃ¤ndige Config mit Test-Ergebnissen)

**Perfekt fÃ¼r:**
- **Setup-Wizard** fÃ¼r Produktiv-System
- Neue Installations-Routine
- Multi-Provider-KompatibilitÃ¤t (Gmail, Outlook, selbst-gehostet)

**Dokumentation:** `docs/dev/Setup-Autodiscover.md`

---

### 2. mercury-quick-test.php â­â­ **EMPFOHLEN FÃœR ENTWICKLUNG**

**Zweck:** VollstÃ¤ndiger SMTP + IMAP Round-Trip Test fÃ¼r Mercury (XAMPP)

**Features:**
- âœ… Automatischer SMTP-Versand (keine manuellen Test-Mails nÃ¶tig)
- âœ… IMAP-Verbindung & Authentifizierung
- âœ… Automatische INBOX-Erkennung (verschiedene Varianten)
- âœ… Email-Suche nach Subject (Mercury-kompatibel)
- âœ… Message-Details lesen (Subject, From, Date)
- âœ… Operationen testen (mark as read, delete)
- âœ… Konfiguration speichern (`mercury-config.json`)

**Verwendung:**
```bash
cd C:\Users\Dienstlaptop-HD\Documents\Privat-Nextcloud\Private_Dateien\Tools_und_Systeme\CI-Inbox

C:\xampp\php\php.exe src/modules/imap/tests/mercury-quick-test.php
```

**Default Credentials:**
- SMTP: `localhost:25` (no auth)
- IMAP: `localhost:143` (no SSL)
- User: `testuser` / `testpass123`
- Email: `testuser@localhost`

**Output bei Erfolg:**
```
=== âœ… ALL TESTS PASSED ===
ğŸ‰ Mercury Configuration is CORRECT! ğŸ‰
```

**Gespeicherte Config:** `src/modules/imap/tests/mercury-config.json`

---

### 3. smtp-imap-roundtrip-test.php

**Zweck:** Interaktiver Round-Trip Test fÃ¼r beliebige SMTP/IMAP Server

**Features:**
- Interaktive Eingabe aller Verbindungsdaten
- UnterstÃ¼tzt externe Mail-Server (Gmail, Outlook, etc.)
- SMTP-Authentication (optional)
- SSL/TLS Support
- 30s Wartezeit fÃ¼r Email-Zustellung

**Verwendung:**
```bash
C:\xampp\php\php.exe src/modules/imap/tests/smtp-imap-roundtrip-test.php
```

Dann Verbindungsdaten eingeben (interaktiv).

**Gut fÃ¼r:**
- Tests mit externen Mail-Providern
- SSL/TLS Tests
- Authentifizierungs-Tests

---

### 4. ~~smtp-imap-autosetup.php~~ âš ï¸ **ARCHIVED**

**Status:** Deprecated â†’ Moved to `_archive/`  
**Replaced by:** `setup-autodiscover.php`

**Reason:** Limited capabilities, superseded by full wizard

---

### 5. ~~manual-test.php~~ âš ï¸ **ARCHIVED**

**Status:** Deprecated â†’ Moved to `_archive/`  
**Replaced by:** `mercury-quick-test.php`

**Reason:** Manual email setup required, no SMTP testing

---

## ğŸ—‚ï¸ Archived Scripts

Old test scripts moved to `_archive/` directory for reference.

**See:** `_archive/README.md` for details

---

## Mercury-spezifische Hinweise

### Message-ID Problematik

**Problem:** Mercury speichert Message-ID Header, aber `getMessageId()` gibt nur numerische UID zurÃ¼ck!

**LÃ¶sung in Tests:**
```php
// âŒ Funktioniert nicht bei Mercury
$foundUid = findByMessageId($msgId);

// âœ… Funktioniert
$foundUid = findBySubject($uniqueSubject);
```

### Bekannte Warnungen (harmlos)

1. **"Array to string conversion"** bei `getFrom()`
   - LÃ¶sung: `implode(', ', $from)` verwenden

2. **"Can't connect to Laptop-Hendrik-ZenFlip"** beim Shutdown
   - Harmlos, IMAP Extension macht Hostname-Lookup

---

## Verwendung fÃ¼r CI-Inbox Setup-Wizard

**Empfohlener Workflow:**

### Production Setup (Web-Wizard)

```php
// Option 1: Direkter Aufruf im Controller
public function setupWizard(Request $request) {
    $emailAddress = $request->input('email');
    
    // Run autodiscover
    $output = shell_exec(
        'php ' . base_path('src/modules/imap/tests/setup-autodiscover.php') . 
        ' <<< "' . $emailAddress . '\n...\n"'
    );
    
    // Load results
    $config = json_decode(
        file_get_contents(base_path('src/modules/imap/tests/setup-config.json')),
        true
    );
    
    return view('setup.result', ['config' => $config]);
}
```

### Development Testing

1. **Test mit Mercury (localhost):**
   ```bash
   php mercury-quick-test.php
   ```

2. **Test mit externem Provider:**
   ```bash
   php setup-autodiscover.php
   # Eingeben: info@gmail.com, Password, etc.
   ```

3. **Test mit spezifischen Settings:**
   ```bash
   php smtp-imap-roundtrip-test.php
   ```

---

## Feature-Vergleich

| Feature | setup-autodiscover | mercury-quick-test | roundtrip-test | autosetup (old) |
|---------|-------------------|-------------------|----------------|-----------------|
| **Auto-detect IMAP** | âœ… | âŒ | âŒ | âŒ |
| **Auto-detect SMTP** | âœ… (8 configs) | âŒ | âŒ | âš ï¸ (2 configs) |
| **Folder Scanning** | âœ… (alle Ordner) | âœ… (INBOX) | âœ… (INBOX) | âš ï¸ (9 Varianten) |
| **Config Speichern** | âœ… (.env + JSON) | âœ… (JSON) | âŒ | âœ… (JSON) |
| **User-freundlich** | âœ…âœ…âœ… | âœ…âœ… | âœ… | âš ï¸ |
| **Error Recovery** | âœ… | âš ï¸ | âœ… | âŒ |
| **Production-Ready** | âœ… | âš ï¸ (Dev only) | âŒ | âŒ |

**Empfehlung:**
- **Produktiv-System:** `setup-autodiscover.php` â­â­â­
- **Entwicklung/Testing:** `mercury-quick-test.php` â­â­
- **Debugging:** `smtp-imap-roundtrip-test.php` â­

---

## Verwendung fÃ¼r CI-Inbox Installer

**Empfohlener Workflow:**

1. **Setup-Wizard startet:**
   ```php
   // FÃ¼hre mercury-quick-test.php aus
   exec('php mercury-quick-test.php', $output, $exitCode);
   ```

2. **Config laden:**
   ```php
   $config = json_decode(file_get_contents('mercury-config.json'), true);
   
   if ($config['test_result'] === 'success') {
       // Auto-configure SMTP/IMAP settings
       $smtp = $config['smtp'];
       $imap = $config['imap'];
   }
   ```

3. **Alternativ: smtp-imap-autosetup.php**
   - Wenn externe Mail-Server
   - Mehr Debug-Infos benÃ¶tigt

---

## Test-Ergebnisse (17. November 2025)

**Getestet mit:**
- Mercury Mail Server (XAMPP) âœ…
- PHP 8.2.12 âœ…
- php-imap Extension âœ…
- ImapClient Module v1.0 âœ…

**Test-Ergebnisse:**

### mercury-quick-test.php
```
âœ… ALL TESTS PASSED (8/8)
- SMTP sending works
- IMAP connection works
- Folder access works ('INBOX')
- Email delivery works (<1s)
- Message reading works
- Operations (mark, delete) work
```

### setup-autodiscover.php
```
âœ… Setup Completed Successfully

Auto-Detected:
- IMAP: localhost:143 (no SSL)
- SMTP: localhost:25 (with auth)
- Inbox: INBOX
- Test message found after 8s
- Configuration saved to .env + setup-config.json
```

**Archivierte Scripts:**
- âŒ `smtp-imap-autosetup.php` â†’ `_archive/` (deprecated)
- âŒ `manual-test.php` â†’ `_archive/` (legacy)
- âŒ `test-wizard.php` â†’ `_archive/` (draft)

---

**NÃ¤chste Schritte:**
- M1 Sprint 1.2: E-Mail-Parser (Body-Sanitization, Attachments, Header-Parsing)
- M1 Sprint 1.3: Threading-Engine
- M1 Sprint 1.4: SMTP-Sending via CI-Inbox
- M3: Web-Setup-Wizard Integration

---

**Dokumentation:**
- **Modul-Doku:** `src/modules/imap/README.md`
- **Setup-Wizard:** `src/modules/imap/docs/Setup-Autodiscover.md`
- **Mercury-Setup:** `docs/dev/Mercury-Setup.md`
